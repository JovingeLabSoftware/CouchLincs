var lincs = require("../lib/lincs.js");
var assert = require('assert');
var couchbase = require('couchbase');

describe('LINCS funtion tests', function () {
    describe('Connectivity', function () {
        it('connects to couchbase', function (done) {
		    lincs.bucket.get("CPC009_A375_6H_X2_F1B3_DUO52HI53LO:J13", function(err, data) {
		    	if(err) throw err;
				assert(data.value.metadata.pert_vehicle === "DMSO");	
				done();
		    });
        });

        // note that if promises are used, we need to use .catch because a 
        // failed assert will throw an error and the promise will then never be
        // fulfilled (rather it will be rejected)
        it('retrieves vehicle for an instance', function (done) {
		    lincs.getVehicle("CPC009_A375_6H_X2_F1B3_DUO52HI53LO:J13")
		    .then(function(veh) {
				assert(veh === "DMSO");	
				done();
		    })
			.catch(function(err) {
				done(err);
			});	
        });

        it('retrieves the second 5000 "gold" instances for cell line A549', function (done) {
		    lincs.getGoldByCell("A549", 5000, 5000)
		    .then(function(res, err) {
		    	assert(res.length == 5000);
		    	done();
		    })
		    .catch(function(e) {
		    });
        });

        it('retrieves all related instances (same cell line, perturbation, dose, duration)', function (done) {
		    lincs.getByPert("A375", "BMP7", 100, 2, 0, 5)
		    .then(function(res) {
		    	assert.equal(res.length , 2);
				done();
		    })
		    .catch(function(e) {
		    	done(e);
		    });
        });


        it('retrieves the range of numeric indices', function (done) {
		    lincs.getNIDRange()
		    .then(function(res) {
		    	assert.ok(res.min);
		    	assert.ok(res.max);
				done();
		    })
		    .catch(function(e) {
		    	done(e);
		    });
        });

        it('retrieves gene expression data', function (done) {
		    lincs.getExpression("CPC009_A375_6H_X2_F1B3_DUO52HI53LO:J13")
		    .then(function(res) {
		    	assert(res.length  == 978);
				done();
		    })
		    .catch(function(e) {
		    	done(e);
		    });
        });

        it.skip('retrieves a list of unique perturbagens of type trt_cp', function (done) {
        	this.timeout(600000);
		    lincs.getPerturbagens('trt_cp')
		    .then(function(res) {
		    	assert.equal(res.length, 978);
				done();
		    })
		    .catch(function(e) {
		    	done(e);
		    });
        });

    });
});
